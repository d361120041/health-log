# ğŸ–¼ï¸ å‰ç«¯å…ƒä»¶æ¶æ§‹è¨­è¨ˆ (Vue 3 + Pinia)

æœ¬æ¶æ§‹åŸºæ–¼ **Vue 3 Composition API** å’Œ **Pinia** ç‹€æ…‹ç®¡ç†ï¼Œå°ˆæ³¨æ–¼æ¨¡çµ„åŒ–ã€å¯é‡ç”¨æ€§ï¼Œä»¥åŠå°å¾Œç«¯ EAV (Entity-Attribute-Value) æ¨¡å¼å’Œé›™ JWT å®‰å…¨æ©Ÿåˆ¶çš„é›†æˆã€‚

## 1\. ğŸ“‚ å°ˆæ¡ˆç›®éŒ„çµæ§‹ (High-Level Structure)

```
src/
â”œâ”€â”€ assets/             # éœæ…‹è³‡æº
â”œâ”€â”€ components/         # åŸºç¤å…ƒä»¶ï¼Œå¯åœ¨å¤šå€‹é é¢é‡ç”¨
â”‚   â”œâ”€â”€ common/         # å…¨åŸŸ/UI å…ƒä»¶ (æŒ‰éˆ•ã€å°èˆªæ¬„)
â”‚   â””â”€â”€ dynamic/        # å°ˆé–€ç”¨æ–¼è™•ç† EAV æ•¸æ“šçš„å‹•æ…‹å…ƒä»¶ (æ ¸å¿ƒ)
â”‚
â”œâ”€â”€ views/              # é é¢å…ƒä»¶ (å°æ‡‰è·¯ç”±)
â”‚   â”œâ”€â”€ Auth/           # ç™»å…¥ã€è¨»å†Š
â”‚   â”œâ”€â”€ Admin/          # å¾Œå°ç®¡ç†é é¢
â”‚   â”œâ”€â”€ Records/        # è¨˜éŒ„ CRUD é é¢
â”‚   â””â”€â”€ Reports/        # è¶¨å‹¢åœ–é é¢
â”‚
â”œâ”€â”€ router/             # Vue Router é…ç½®
â”œâ”€â”€ stores/             # Pinia ç‹€æ…‹ç®¡ç†æ¨¡çµ„
â”œâ”€â”€ services/           # å°è£ Axios è«‹æ±‚å’Œ API é‚è¼¯ (å«æ””æˆªå™¨)
â””â”€â”€ main.js             # æ‡‰ç”¨ç¨‹å¼å…¥å£
```

## 2\. ğŸ§  ç‹€æ…‹ç®¡ç†è¨­è¨ˆ (Pinia Stores)

Pinia Store ä½œç‚ºå–®ä¸€æ•¸æ“šæºï¼Œç®¡ç†æ‡‰ç”¨ç¨‹å¼çš„å…±äº«ç‹€æ…‹ã€‚

| Store åç¨± | æ ¸å¿ƒ State æ•¸æ“š | é—œéµ Actions (æ–¹æ³•) |
| :--- | :--- | :--- |
| **`authStore`** | `accessToken`, `user` (id, email, roles), `isAuthenticated` | `login()`, `logout()`, **`refreshAccessToken()`** (è™•ç† 401 çºŒç´„) |
| **`settingsStore`** | `fieldSettings` (å¾Œå°å®šç¾©çš„è¨˜éŒ„æ¬„ä½åˆ—è¡¨) | `fetchFieldSettings()`, `updateSettings()` (Admin) |
| **`recordsStore`** | `dailyRecord` (ç•¶å‰ç·¨è¼¯è¨˜éŒ„), `recordsList` (æ­·å²è¨˜éŒ„åˆ—è¡¨) | `fetchRecordByDate()`, `saveRecord()` |
| **`reportStore`** | `trendData` (ç”¨æ–¼åœ–è¡¨çš„æ•¸æ“šçµæ§‹) | `fetchTrendData()` |

## 3\. ğŸ§© æ ¸å¿ƒå…ƒä»¶è¨­è¨ˆ (Component Strategy)

### 3.1 å‹•æ…‹è¡¨å–®çš„æ ¸å¿ƒå…ƒä»¶ (Dynamic Forms)

é€™äº›å…ƒä»¶ç”¨æ–¼è™•ç†å¾Œç«¯ EAV æ¨¡å¼ä¸‹çš„å‹•æ…‹æ¬„ä½ã€‚

| å…ƒä»¶åç¨± | è·è²¬ (Responsibility) | é—œéµæŠ€è¡“é» |
| :--- | :--- | :--- |
| **`DynamicRecordForm.vue`** | **ä¸»è¦è¡¨å–®å®¹å™¨ã€‚** æ ¹æ“š `settingsStore.fieldSettings` è¿­ä»£æ¸²æŸ“å­å…ƒä»¶ã€‚ | æ ¹æ“š `setting_id` æ§‹å»ºè¼¸å‡º DTO çµæ§‹ã€‚ |
| **`InputNumber.vue`** | æ¸²æŸ“ `dataType: "NUMBER"` æ¬„ä½ã€‚ | è™•ç†æ•¸å­—è¼¸å…¥å’Œå–®ä½é¡¯ç¤ºã€‚ |
| **`InputSelect.vue`** | æ¸²æŸ“ `dataType: "ENUM"` æ¬„ä½ã€‚ | æ ¹æ“š `fieldSetting.options` å‹•æ…‹ç”Ÿæˆé¸é …ã€‚ |
| **`InputTextarea.vue`** | æ¸²æŸ“ `dataType: "TEXT"` æ¬„ä½ã€‚ | è™•ç†å¤šè¡Œæ–‡æœ¬è¼¸å…¥ã€‚ |

### 3.2 å®‰å…¨èˆ‡ä½ˆå±€å…ƒä»¶

| å…ƒä»¶åç¨± | è·è²¬ (Responsibility) | é—œéµæŠ€è¡“é» |
| :--- | :--- | :--- |
| **`AppLayout.vue`** | æ‡‰ç”¨ç¨‹å¼åŸºç¤ä½ˆå±€ã€‚ | åŒ…å«å°èˆªæ¬„å’Œé è…³ã€‚ |
| **`AdminGuard.vue`** | **æ¬Šé™æ§åˆ¶å…ƒä»¶ã€‚** æª¢æŸ¥ `authStore.user.roles` æ˜¯å¦åŒ…å« 'ADMIN' è§’è‰²ï¼Œæ±ºå®šæ˜¯å¦æ¸²æŸ“ç®¡ç†ä»‹é¢ã€‚ | Composition API ä¸­çš„è¨ˆç®—å±¬æ€§ (Computed Property) æª¢æŸ¥è§’è‰²ã€‚ |

## 4\. ğŸ”— è·¯ç”±èˆ‡ API æœå‹™é›†æˆ

### 4.1 Vue Router é…ç½®

  * **è·¯ç”±å®ˆè¡› (Navigation Guards):** åœ¨ `router/index.js` ä¸­é…ç½® `beforeEach` å®ˆè¡›ï¼Œæª¢æŸ¥ `authStore.isAuthenticated` ä¾†ä¿è­·å—é™åˆ¶çš„è·¯ç”±ã€‚
  * **Admin è·¯ç”±:** å° Admin é é¢æ·»åŠ  `meta: { requiresAdmin: true }` æ¨™ç±¤ï¼Œåœ¨å®ˆè¡›ä¸­é€²è¡Œæ›´ç´°ç·»çš„è§’è‰²æª¢æŸ¥ã€‚

### 4.2 API æœå‹™å±¤ (`services/apiClient.js`)

  * **Axios å¯¦ä¾‹é…ç½®:** å°è£ Axios å¯¦ä¾‹ï¼Œè¨­ç½®å¾Œç«¯ API çš„åŸºç¤ URLã€‚
  * **Request æ””æˆªå™¨:** è‡ªå‹•å°‡ Access Token å¾ `authStore` æå–ä¸¦é™„åŠ åˆ° `Authorization: Bearer <Token>` Headerã€‚
  * **Response æ””æˆªå™¨ (çºŒç´„æ ¸å¿ƒ):**
    1.  æ•ç² HTTP `401` ç‹€æ…‹ç¢¼ã€‚
    2.  æª¢æŸ¥æ˜¯å¦ç‚º Token éæœŸéŒ¯èª¤ã€‚
    3.  å¦‚æœç¢ºèªéæœŸï¼Œå‘¼å« `authStore.refreshAccessToken()`ã€‚
    4.  å¦‚æœåˆ·æ–°æˆåŠŸï¼Œä½¿ç”¨æ–°çš„ Access Token **é‡è©¦ (Retry)** åŸæœ¬å¤±æ•—çš„ API è«‹æ±‚ã€‚
    5.  å¦‚æœåˆ·æ–°å¤±æ•—ï¼Œå¼·åˆ¶è·³è½‰åˆ° `/login` é é¢ã€‚

-----