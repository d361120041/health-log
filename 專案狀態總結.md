# ğŸ“‹ å°ˆæ¡ˆé–‹ç™¼ç‹€æ…‹ç¸½çµ

**æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š** 2024-12-27  
**å°ˆæ¡ˆåç¨±ï¼š** æ¯æ—¥èº«é«”ç‹€æ³è¨˜éŒ„æ‡‰ç”¨ç¨‹å¼ (Health Tracker Web App)

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å¾Œç«¯é–‹ç™¼ï¼ˆJava Spring Bootï¼‰

#### 1.1 å°ˆæ¡ˆçµæ§‹ï¼ˆMaven å¤šæ¨¡çµ„ï¼‰
- `app-model`: å¯¦é«”é¡åˆ¥å’Œ DTO
- `app-data`: Repository å±¤ï¼ˆSpring Data JPAï¼‰
- `app-service`: æ¥­å‹™é‚è¼¯å±¤
- `app-web`: Controller å±¤å’Œ Spring Boot æ‡‰ç”¨ç¨‹å¼å…¥å£

#### 1.2 è³‡æ–™åº«å±¤ï¼ˆå·²å®Œæˆä¸¦æ¸¬è©¦ï¼‰
- âœ… æ‰€æœ‰ Entity é¡åˆ¥ï¼ˆUser, Role, FieldSetting, DailyRecord, RecordDataï¼‰
- âœ… æ‰€æœ‰ Repository ä»‹é¢
- âœ… Repository æ¸¬è©¦ï¼ˆä½¿ç”¨ `@DataJpaTest` + H2 å…§å­˜è³‡æ–™åº«ï¼‰
- âœ… æ¸¬è©¦çµæœï¼šæ‰€æœ‰ Repository æ¸¬è©¦é€šé

#### 1.3 æ¥­å‹™é‚è¼¯å±¤ï¼ˆå·²å®Œæˆä¸¦æ¸¬è©¦ï¼‰
- âœ… `RefreshTokenService` - Redis Token ç®¡ç†
- âœ… `FieldSettingService` - æ¬„ä½è¨­å®šç®¡ç†
- âœ… `DailyRecordService` - æ¯æ—¥è¨˜éŒ„ç®¡ç†ï¼ˆEAV è½‰æ›ï¼‰
- âœ… `ReportService` - å ±è¡¨æ•¸æ“šç”Ÿæˆ
- âœ… `JwtTokenUtil` - JWT Token å·¥å…·é¡
- âœ… `AuthService` - èªè­‰æœå‹™ï¼ˆç™»å…¥ã€ç™»å‡ºã€åˆ·æ–° Tokenï¼‰
- âœ… Service æ¸¬è©¦ï¼ˆä½¿ç”¨ Mockitoï¼‰
- âœ… æ¸¬è©¦çµæœï¼šæ‰€æœ‰ Service æ¸¬è©¦é€šé

#### 1.4 Web å±¤ï¼ˆå·²å®Œæˆä¸¦æ¸¬è©¦ï¼‰
- âœ… `AuthController` - èªè­‰ç«¯é»ï¼ˆ`/api/auth/login`, `/api/auth/refresh`, `/api/auth/logout`ï¼‰
- âœ… `FieldSettingController` - æ¬„ä½è¨­å®šç®¡ç†ç«¯é»
- âœ… `DailyRecordController` - æ¯æ—¥è¨˜éŒ„ CRUD ç«¯é»
- âœ… `ReportController` - å ±è¡¨æ•¸æ“šç«¯é»
- âœ… `SecurityConfig` - Spring Security é…ç½®
- âœ… `JwtRequestFilter` - JWT é©—è­‰éæ¿¾å™¨
- âœ… `PasswordEncoderConfig` - å¯†ç¢¼ç·¨ç¢¼å™¨é…ç½®ï¼ˆè§£æ±ºå¾ªç’°ä¾è³´ï¼‰
- âœ… `SecurityUtil` - å®‰å…¨å·¥å…·é¡
- âœ… Controller æ¸¬è©¦ï¼ˆä½¿ç”¨ `@SpringBootTest` + `@AutoConfigureMockMvc`ï¼‰
- âœ… æ¸¬è©¦çµæœï¼š**31 å€‹æ¸¬è©¦å…¨éƒ¨é€šé**ï¼ˆ0 å¤±æ•—ï¼Œ0 éŒ¯èª¤ï¼‰

#### 1.5 å®‰å…¨æ©Ÿåˆ¶
- âœ… JWT Access Tokenï¼ˆçŸ­æš«éæœŸï¼Œå­˜æ–¼å‰ç«¯ Piniaï¼‰
- âœ… JWT Refresh Tokenï¼ˆé•·æœŸéæœŸï¼Œå­˜æ–¼ HTTP-only Cookie + Redisï¼‰
- âœ… Spring Security æ•´åˆ
- âœ… è§’è‰²æ¬Šé™æ§åˆ¶ï¼ˆUSER, ADMINï¼‰

#### 1.6 é…ç½®æª”æ¡ˆ
- âœ… `application.properties` - ä¸»é…ç½®ï¼ˆPostgreSQL, Redis, JWTï¼‰
- âœ… `application-test.properties` - æ¸¬è©¦é…ç½®ï¼ˆH2 è³‡æ–™åº«ï¼‰

---

## ğŸš§ å¾…å®Œæˆçš„å·¥ä½œ

### å‰ç«¯é–‹ç™¼ï¼ˆVue 3 + Piniaï¼‰

#### éšæ®µ 1ï¼šåŸºç¤è¨­æ–½è¨­ç½®
- [ ] å®‰è£ä¾è³´
  - [ ] `axios`ï¼ˆAPI è«‹æ±‚ï¼‰
  - [ ] UI åº«ï¼ˆå¯é¸ï¼šElement Plus / Vuetifyï¼‰
- [ ] å‰µå»º `services/apiClient.js`
  - [ ] é…ç½® Axios å¯¦ä¾‹ï¼ˆåŸºç¤ URLï¼‰
  - [ ] Request æ””æˆªå™¨ï¼ˆè‡ªå‹•æ·»åŠ  Access Tokenï¼‰
  - [ ] Response æ””æˆªå™¨ï¼ˆè™•ç† 401ï¼Œè‡ªå‹•åˆ·æ–° Tokenï¼‰

#### éšæ®µ 2ï¼šç‹€æ…‹ç®¡ç†ï¼ˆPinia Storesï¼‰
- [ ] `stores/authStore.js`
  - [ ] State: `accessToken`, `user`, `isAuthenticated`
  - [ ] Actions: `login()`, `logout()`, `refreshAccessToken()`
- [ ] `stores/settingsStore.js`
  - [ ] State: `fieldSettings`
  - [ ] Actions: `fetchFieldSettings()`, `updateSettings()`
- [ ] `stores/recordsStore.js`
  - [ ] State: `dailyRecord`, `recordsList`
  - [ ] Actions: `fetchRecordByDate()`, `saveRecord()`
- [ ] `stores/reportStore.js`
  - [ ] State: `trendData`
  - [ ] Actions: `fetchTrendData()`

#### éšæ®µ 3ï¼šè·¯ç”±èˆ‡å®ˆè¡›
- [ ] é…ç½® `router/index.js`
  - [ ] å®šç¾©æ‰€æœ‰è·¯ç”±
  - [ ] è·¯ç”±å®ˆè¡›ï¼ˆ`beforeEach`ï¼‰
    - [ ] èªè­‰æª¢æŸ¥
    - [ ] Admin æ¬Šé™æª¢æŸ¥ï¼ˆ`meta: { requiresAdmin: true }`ï¼‰

#### éšæ®µ 4ï¼šæ ¸å¿ƒå…ƒä»¶
- [ ] `components/dynamic/DynamicRecordForm.vue`ï¼ˆå‹•æ…‹è¡¨å–®å®¹å™¨ï¼‰
- [ ] `components/dynamic/InputNumber.vue`ï¼ˆæ•¸å­—è¼¸å…¥ï¼‰
- [ ] `components/dynamic/InputSelect.vue`ï¼ˆä¸‹æ‹‰é¸å–®ï¼‰
- [ ] `components/dynamic/InputTextarea.vue`ï¼ˆæ–‡å­—è¼¸å…¥ï¼‰
- [ ] `components/common/AppLayout.vue`ï¼ˆæ‡‰ç”¨ç¨‹å¼ä½ˆå±€ï¼‰
- [ ] `components/common/AdminGuard.vue`ï¼ˆæ¬Šé™å®ˆè¡›å…ƒä»¶ï¼‰

#### éšæ®µ 5ï¼šé é¢å…ƒä»¶
- [ ] `views/Auth/Login.vue`ï¼ˆç™»å…¥é é¢ï¼‰
- [ ] `views/Records/RecordList.vue`ï¼ˆè¨˜éŒ„åˆ—è¡¨ï¼‰
- [ ] `views/Records/RecordForm.vue`ï¼ˆæ–°å¢/ç·¨è¼¯è¨˜éŒ„ï¼‰
- [ ] `views/Reports/TrendChart.vue`ï¼ˆè¶¨å‹¢åœ–è¡¨ï¼‰
- [ ] `views/Admin/FieldSettings.vue`ï¼ˆæ¬„ä½è¨­å®šç®¡ç†ï¼‰

#### éšæ®µ 6ï¼šæ•´åˆèˆ‡æ¸¬è©¦
- [ ] æ¸¬è©¦ç™»å…¥æµç¨‹
- [ ] æ¸¬è©¦ Token åˆ·æ–°æ©Ÿåˆ¶
- [ ] æ¸¬è©¦å‹•æ…‹è¡¨å–®æ¸²æŸ“
- [ ] æ¸¬è©¦ API æ•´åˆ

---

## ğŸ“ é—œéµæª”æ¡ˆä½ç½®

### å¾Œç«¯
```
health-log-java/
â”œâ”€â”€ app-model/src/main/java/tw/danielchiang/health_log/model/
â”‚   â”œâ”€â”€ entity/          # å¯¦é«”é¡åˆ¥
â”‚   â””â”€â”€ dto/             # DTO é¡åˆ¥
â”œâ”€â”€ app-data/src/main/java/tw/danielchiang/health_log/data/
â”‚   â””â”€â”€ repository/      # Repository ä»‹é¢
â”œâ”€â”€ app-service/src/main/java/tw/danielchiang/health_log/service/
â”‚   â””â”€â”€ *.java           # Service é¡åˆ¥
â””â”€â”€ app-web/src/main/java/tw/danielchiang/health_log/
    â”œâ”€â”€ config/          # é…ç½®é¡åˆ¥ï¼ˆSecurityConfig, PasswordEncoderConfigï¼‰
    â”œâ”€â”€ web/
    â”‚   â”œâ”€â”€ controller/  # Controller é¡åˆ¥
    â”‚   â”œâ”€â”€ filter/      # JwtRequestFilter
    â”‚   â””â”€â”€ util/        # SecurityUtil
    â””â”€â”€ HealthLogApplication.java
```

### å‰ç«¯
```
health-log-vue/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/        # API æœå‹™å±¤ï¼ˆå¾…å‰µå»ºï¼‰
â”‚   â”œâ”€â”€ stores/          # Pinia Storesï¼ˆå¾…å‰µå»ºï¼‰
â”‚   â”œâ”€â”€ router/          # è·¯ç”±é…ç½®ï¼ˆå¾…å®Œå–„ï¼‰
â”‚   â”œâ”€â”€ components/      # å…ƒä»¶ï¼ˆå¾…å‰µå»ºï¼‰
â”‚   â”‚   â”œâ”€â”€ common/      # é€šç”¨å…ƒä»¶
â”‚   â”‚   â””â”€â”€ dynamic/     # å‹•æ…‹è¡¨å–®å…ƒä»¶
â”‚   â””â”€â”€ views/           # é é¢å…ƒä»¶ï¼ˆå¾…å‰µå»ºï¼‰
â”‚       â”œâ”€â”€ Auth/
â”‚       â”œâ”€â”€ Records/
â”‚       â”œâ”€â”€ Reports/
â”‚       â””â”€â”€ Admin/
```

---

## ğŸ”‘ é‡è¦æŠ€è¡“ç´°ç¯€

### å¾Œç«¯ API ç«¯é»
- `POST /api/auth/login` - ç™»å…¥ï¼ˆè¿”å› Access Tokenï¼Œè¨­ç½® Refresh Token Cookieï¼‰
- `POST /api/auth/refresh` - åˆ·æ–° Access Tokenï¼ˆå¾ Cookie è®€å– Refresh Tokenï¼‰
- `POST /api/auth/logout` - ç™»å‡ºï¼ˆæ¸…é™¤ Refresh Token Cookieï¼‰
- `GET /api/settings/fields` - ç²å–å‹•æ…‹æ¬„ä½è¨­å®šï¼ˆå…¬é–‹ç«¯é»ï¼‰
- `GET /api/records` - ç²å–è¨˜éŒ„åˆ—è¡¨ï¼ˆéœ€èªè­‰ï¼‰
- `GET /api/records/{id}` - ç²å–å–®ä¸€è¨˜éŒ„ï¼ˆéœ€èªè­‰ï¼‰
- `POST /api/records` - å‰µå»ºè¨˜éŒ„ï¼ˆéœ€èªè­‰ï¼‰
- `PUT /api/records/{id}` - æ›´æ–°è¨˜éŒ„ï¼ˆéœ€èªè­‰ï¼‰
- `DELETE /api/records/{id}` - åˆªé™¤è¨˜éŒ„ï¼ˆéœ€èªè­‰ï¼‰
- `GET /api/reports/trend` - ç²å–è¶¨å‹¢æ•¸æ“šï¼ˆéœ€èªè­‰ï¼‰

### JWT Token æ©Ÿåˆ¶
- **Access Token**: å­˜æ–¼å‰ç«¯ Pinia Storeï¼Œæ¯æ¬¡ API è«‹æ±‚æ™‚æ·»åŠ åˆ° `Authorization: Bearer <token>` Header
- **Refresh Token**: å­˜æ–¼ HTTP-only Cookieï¼ˆåç¨±ï¼š`refresh_token`ï¼‰ï¼Œæœ‰æ•ˆæœŸ 7 å¤©
- **Token åˆ·æ–°æµç¨‹**ï¼š
  1. API è«‹æ±‚è¿”å› 401
  2. Response æ””æˆªå™¨æ•ç² 401
  3. è‡ªå‹•èª¿ç”¨ `/api/auth/refresh`ï¼ˆCookie è‡ªå‹•æ”œå¸¶ï¼‰
  4. ç²å–æ–°çš„ Access Token
  5. é‡è©¦åŸæœ¬å¤±æ•—çš„è«‹æ±‚

### EAV æ¨¡å¼è½‰æ›
- **å‰µå»ºè¨˜éŒ„**ï¼šå‰ç«¯ç™¼é€æ‰å¹³åŒ– JSON â†’ å¾Œç«¯è½‰æ›ç‚º EAV æ ¼å¼å­˜å„²
- **æŸ¥è©¢è¨˜éŒ„**ï¼šå¾Œç«¯å¾ EAV æ ¼å¼æŸ¥è©¢ â†’ è½‰æ›ç‚ºæ‰å¹³åŒ– DTO è¿”å›å‰ç«¯

### æ¸¬è©¦é…ç½®
- ä½¿ç”¨ H2 å…§å­˜è³‡æ–™åº«é€²è¡Œæ¸¬è©¦
- æ¸¬è©¦é…ç½®æª”æ¡ˆï¼š`app-web/src/test/resources/application-test.properties`
- æ¸¬è©¦æ™‚ä½¿ç”¨ `@ActiveProfiles("test")` å•Ÿç”¨æ¸¬è©¦é…ç½®

---

## ğŸ› å·²è§£æ±ºçš„å•é¡Œ

1. âœ… Maven å¤šæ¨¡çµ„ä¾è³´å•é¡Œ
2. âœ… `@DataJpaTest` æ‰¾ä¸åˆ° `@SpringBootConfiguration`ï¼ˆå‰µå»º `TestApplication.java`ï¼‰
3. âœ… Mockito åœ¨ Java 21 çš„å…¼å®¹æ€§å•é¡Œï¼ˆä½¿ç”¨ `mockito-subclass`ï¼‰
4. âœ… å¾ªç’°ä¾è³´å•é¡Œï¼ˆ`PasswordEncoder` åˆ†é›¢åˆ°ç¨ç«‹é…ç½®é¡ï¼‰
5. âœ… Controller æ¸¬è©¦å¾ `@WebMvcTest` åˆ‡æ›åˆ° `@SpringBootTest`
6. âœ… Security é…ç½®ï¼š`/api/auth/logout` å’Œ `/api/settings/fields` è¨­ç‚ºå…¬é–‹ç«¯é»

---

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè­°

1. **å„ªå…ˆé–‹å§‹å‰ç«¯é–‹ç™¼**ï¼Œå¾åŸºç¤è¨­æ–½è¨­ç½®é–‹å§‹ï¼š
   - å®‰è£ `axios`
   - å‰µå»º `services/apiClient.js` ä¸¦å¯¦ç¾ Token åˆ·æ–°æ©Ÿåˆ¶
   - å‰µå»º `stores/authStore.js` å¯¦ç¾èªè­‰é‚è¼¯

2. **ç„¶å¾Œå¯¦ç¾ç™»å…¥åŠŸèƒ½**ï¼š
   - å‰µå»º `views/Auth/Login.vue`
   - é…ç½®è·¯ç”±
   - æ¸¬è©¦ç™»å…¥æµç¨‹

3. **æ¥è‘—å¯¦ç¾å‹•æ…‹è¡¨å–®**ï¼š
   - å‰µå»ºå‹•æ…‹è¡¨å–®å…ƒä»¶
   - å¯¦ç¾è¨˜éŒ„çš„å‰µå»ºå’Œç·¨è¼¯åŠŸèƒ½

4. **æœ€å¾Œå¯¦ç¾å ±è¡¨å’Œç®¡ç†åŠŸèƒ½**

---

## ğŸ”— ç›¸é—œæ–‡æª”

- `é–‹ç™¼æ–‡ä»¶.md` - æ•´é«”æ¶æ§‹å’ŒæŠ€è¡“æ£§èªªæ˜
- `è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ.md` - è³‡æ–™åº«è¡¨çµæ§‹è¨­è¨ˆ
- `å¾Œç«¯æ¨¡çµ„åŠé¡åˆ¥æ¶æ§‹è¨­è¨ˆ.md` - å¾Œç«¯æ¨¡çµ„çµæ§‹
- `å‰ç«¯å…ƒä»¶æ¶æ§‹è¨­è¨ˆ.md` - å‰ç«¯å…ƒä»¶è¨­è¨ˆï¼ˆ**é‡è¦åƒè€ƒ**ï¼‰

---

**æç¤ºï¼š** åœ¨æ–°æœƒè©±ä¸­ï¼Œå¯ä»¥åƒè€ƒæ­¤æ–‡æª”å¿«é€Ÿäº†è§£å°ˆæ¡ˆç‹€æ…‹ï¼Œä¸¦å¾ã€Œå¾…å®Œæˆçš„å·¥ä½œã€éƒ¨åˆ†ç¹¼çºŒé–‹ç™¼ã€‚

