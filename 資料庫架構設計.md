# 🗄️ 專案最終資料庫架構設計 (PostgreSQL)

本資料庫採用 **PostgreSQL BIGSERIAL** 作為所有核心實體的主鍵，以保證高效能的查詢和數據 JOIN 操作。

## 1. 🔑 身份與權限管理 (Security & Authentication)

### A. `roles` (角色表)

| 欄位名稱 | 資料類型 | 描述 | 約束/備註 |
| :--- | :--- | :--- | :--- |
| **role_id** | SERIAL (PK) | 主鍵 | 自動遞增 |
| **role_name** | VARCHAR(50) | 角色名稱 | **UNIQUE**, NOT NULL (e.g., 'ADMIN', 'USER') |

### B. `users` (使用者表)

| 欄位名稱 | 資料類型 | 描述 | 約束/備註 |
| :--- | :--- | :--- | :--- |
| **user_id** | BIGSERIAL (PK) | 主鍵 | 自動遞增 |
| **email** | VARCHAR(255) | 登入郵箱 | **UNIQUE**, NOT NULL |
| **password_hash** | VARCHAR(255) | 密碼雜湊值 (bcrypt) | NOT NULL |
| **role_id** | INT (FK) | 角色 ID | REFERENCES `roles` |
| **created_at** | TIMESTAMP WITH TIME ZONE | 帳號創建時間 | NOT NULL, **DEFAULT now()** (JPA 實體可省略設定) |
| **is_active** | BOOLEAN | 帳號狀態 | NOT NULL, DEFAULT TRUE |

---

## 2. 📝 記錄配置管理 (Field Settings - EAV Attribute)

### C. `field_settings` (欄位設定表)

此表由 Admin 管理，支援前台動態表單生成。

| 欄位名稱 | 資料類型 | 描述 | 約束/備註 |
| :--- | :--- | :--- | :--- |
| **setting_id** | SERIAL (PK) | 主鍵 | 自動遞增 |
| **field_name** | VARCHAR(100) | 欄位顯示名稱 | UNIQUE, NOT NULL |
| **data_type** | VARCHAR(20) | 資料類型 | NOT NULL (e.g., 'NUMBER', 'TEXT', 'ENUM') |
| **unit** | VARCHAR(50) | 測量單位 | NULLABLE (e.g., 'kg', 'hour') |
| **is_required** | BOOLEAN | 是否為必填欄位 | NOT NULL, DEFAULT FALSE |
| **options** | TEXT | ENUM 類型時的選項列表 (JSON 或逗號分隔) | NULLABLE |
| **is_active** | BOOLEAN | 欄位是否啟用 | NOT NULL, DEFAULT TRUE |

---

## 3. 💾 每日記錄與數據 (Daily Records - EAV Entity & Value)

### D. `daily_records` (每日記錄主表)

| 欄位名稱 | 資料類型 | 描述 | 約束/備註 |
| :--- | :--- | :--- | :--- |
| **record_id** | BIGSERIAL (PK) | 主鍵 | 自動遞增 |
| **user_id** | BIGINT (FK) | 所屬使用者 ID | REFERENCES `users` |
| **record_date** | DATE | 記錄日期 | NOT NULL |
| **created_at** | TIMESTAMP WITH TIME ZONE | 記錄創建時間 | NOT NULL, **DEFAULT now()** |
| **複合唯一索引** | - | - | **UNIQUE(user_id, record_date)** (確保使用者一天只有一筆) |

### E. `record_data` (記錄數值表 - EAV Value)

| 欄位名稱 | 資料類型 | 描述 | 約束/備註 |
| :--- | :--- | :--- | :--- |
| **data_id** | BIGSERIAL (PK) | 主鍵 | 自動遞增 |
| **record_id** | BIGINT (FK) | 所屬的每日記錄 ID | REFERENCES `daily_records` (**ON DELETE CASCADE**) |
| **setting_id** | INT (FK) | 對應的欄位設定 ID | REFERENCES `field_settings` |
| **value_text** | TEXT | 實際記錄的數值或文本 | NOT NULL (所有類型暫存為 TEXT) |
| **複合唯一索引** | - | - | **UNIQUE(record_id, setting_id)** (確保一筆記錄中欄位不重複) |

---

## 4. 📈 效能優化與索引策略

為了加速查詢和趨勢圖生成，以下索引是必要的：

* **`users`:** `UNIQUE(email)`。
* **`daily_records`:** `UNIQUE(user_id, record_date)`。
* **`record_data`:**
    * `UNIQUE(record_id, setting_id)`。
    * **趨勢查詢優化索引:** `(setting_id, record_id)` (加速按特定欄位進行篩選和時間排序)。

---