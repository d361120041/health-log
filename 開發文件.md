# 🚀 每日身體狀況記錄應用程式：架構設計文檔

## 1. 📋 應用程式概覽與技術棧

| 項目 | 描述 |
| :--- | :--- |
| **應用名稱** | 每日身體狀況記錄應用程式 (Health Tracker Web App) |
| **核心需求** | 記錄每日身體狀況，支援後台動態設定記錄欄位。 |
| **用戶角色** | 1. **User (前台)**：記錄、查詢、視覺化個人數據。 2. **Admin (後台)**：管理使用者和設定記錄欄位。 |

### 1.1 核心技術棧 (Technology Stack)

| 層級 (Layer) | 技術 (Technology) | 版本/框架 | 備註 |
| :--- | :--- | :--- | :--- |
| **後端 (API/Logic)** | Java | Java 21 | 高性能運行環境。 |
| | Spring Boot | 3.5.7 | RESTful API 開發。 |
| **前端 (Presentation)** | Vue.js | Vue 3 Composition API | 使用 Pinia 進行狀態管理。 |
| **主要資料庫 (DB)** | PostgreSQL | N/A | 儲存核心業務數據。 |
| **緩存服務 (Cache)** | Redis | N/A | 專用於高效儲存和管理 Refresh Token。 |

## 2. 🏛️ 系統架構與設計模式

### 2.1 數據結構核心：EAV 模式 (Entity-Attribute-Value)

* **目的：** 實現後台對記錄欄位的動態配置，無需修改資料表結構。
* **關鍵資料表：**
    * **`field_settings` (Attribute)：** 管理員定義的記錄項目。
    * **`daily_records` (Entity)：** 每日記錄的主體 (與 `user_id`, `record_date` 綁定)。
    * **`record_data` (Value)：** 儲存特定 `record_id` 對應特定 `setting_id` 的實際數值。

### 2.2 核心數據流轉換

| 流程 | 轉換類型 | 說明 |
| :--- | :--- | :--- |
| **記錄創建 (POST)** | **扁平化 -> EAV** | 後端驗證後，將單一記錄拆解，寫入多行 `record_data`。 |
| **記錄查詢 (GET)** | **EAV -> 扁平化** | 執行複雜的 SQL `JOIN` 查詢，將 EAV 數據彙整 (Pivot) 成單一 DTO (內含 Map 結構) 響應給前端。 |

---

## 3. 🔒 安全機制：雙 JWT Token 與 Redis 管理

| Token 類型 | 目的 | 儲存位置 | 過期時間 | 處理技術 |
| :--- | :--- | :--- | :--- | :--- |
| **Access Token** | 訪問受保護資源 (每次 API 呼叫) | 前端 **Pinia 記憶體** | 短暫 (5-30 分鐘) | Spring Security JWT Filter |
| **Refresh Token** | 續約 Access Token | 後端 **HTTP-only Secure Cookie** | 較長 (7-30 天) | Spring Boot **Redis** 服務 |

### 3.1 Refresh Token 續約流程

1.  前端請求 API 收到 `401 Unauthorized` (Access Token 過期)。
2.  前端呼叫 `/api/auth/refresh` 接口，請求自動攜帶 HTTP-only Cookie 中的 Refresh Token ID。
3.  後端 (Spring Boot) 從 **Redis** 檢查該 ID 是否存在且有效。
4.  **驗證通過：** 後端從 Redis 刪除舊 Token (撤銷)，生成新的 Access Token 和新的 Refresh Token ID，將新的 ID 存入 Redis，並將新的 Access Token 和新的 HTTP-only Cookie 返回給前端。
5.  **驗證失敗：** 強制要求使用者重新登入。

---

## 4. 💻 功能模組與 API 設計

### 4.1 後台 (Admin) 記錄設定管理

| 介面 (Endpoint) | HTTP 方法 | 權限 | 職責 |
| :--- | :--- | :--- | :--- |
| `/api/admin/settings/fields` | POST/PUT/DELETE | ADMIN | 管理員定義記錄欄位 (名稱、類型、單位等)。 |
| `/api/settings/fields` | GET | USER, ADMIN | 前端用於獲取設定，以動態渲染表單。 |

### 4.2 前台 (User) 核心數據接口

| 介面 (Endpoint) | HTTP 方法 | 權限 | 職責 |
| :--- | :--- | :--- | :--- |
| `/api/auth/login` | POST | Public | 登入並取得雙 Token。 |
| `/api/records` | POST | USER | 創建新的每日記錄 (EAV 寫入)。 |
| `/api/records/{date}` | GET | USER | 查詢單日記錄詳情 (EAV 轉換)。 |
| `/api/reports/trend` | GET | USER | 查詢特定 `field_id` 在一段時間內的數據，用於趨勢圖。 |

---

## 5. 💡 關鍵實作要點 (Spring Boot/Vue 3)

### Spring Boot 後端
* **SecurityConfig:** 確保配置 URL 權限，例如 `/api/admin/**` 需 `hasRole('ADMIN')`。
* **Redis Service:** 創建 `RefreshTokenService` 專門負責 Redis 的 SET/GET/DEL 操作。
* **EAV Service 邏輯:** 使用 Spring Data JPA 的 `@Query` 進行複雜的 JOIN 查詢，並在 Service 層將 EAV 結果手動彙整為 DTO。

### Vue 3 前端
* **Pinia State:** 儲存 `field_settings` 和 Access Token。
* **動態表單元件:** 根據 `field_settings` 提供的 `dataType` (NUMBER, TEXT, ENUM) 屬性，動態渲染對應的 Vue 輸入元件。
* **Axios 攔截器:** 實現自動附加 Access Token 和處理 401 錯誤重試機制。